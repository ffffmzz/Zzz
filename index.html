<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Singapore PSI — Realtime Readings</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f8fa; color: #111; }
    header { background: #0b5fff; color: #fff; padding: 16px 20px; }
    header h1 { margin: 0 0 4px; font-size: 20px; }
    header small { opacity: .9; }
    main { max-width: 1100px; margin: 20px auto; padding: 0 16px 40px; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,.04); }
    .toolbar { display: flex; gap: 8px; align-items: center; padding: 12px 14px; border-bottom: 1px solid #e5e7eb; }
    .toolbar button {
      border: 1px solid #d1d5db; background: #fff; border-radius: 8px; padding: 8px 10px; cursor: pointer;
    }
    .toolbar .status { margin-left: auto; font-size: 12px; color: #374151; }
    .wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { border-bottom: 1px solid #f0f0f0; padding: 10px 12px; text-align: right; white-space: nowrap; }
    th:first-child, td:first-child { text-align: left; position: sticky; left: 0; background: #fff; }
    thead th { background: #f9fafb; font-weight: 600; }
    tfoot td { background: #fafafa; font-size: 12px; color: #4b5563; }
    .muted { color: #6b7280; }
    .error { color: #b91c1c; }
    .legend { padding: 10px 14px; font-size: 12px; color: #4b5563; border-top: 1px solid #e5e7eb; }
    a { color: inherit; }
  </style>
</head>
<body>
  <header>
    <h1>Singapore PSI — Realtime Readings</h1>
    <small>Source: <code>https://api.data.gov.sg/v1/environment/psi</code></small>
  </header>

  <main>
    <div class="card">
      <div class="toolbar">
        <button id="refreshBtn" title="Fetch latest">Refresh</button>
        <span class="status" id="status">Loading…</span>
      </div>
      <div class="wrap">
        <table id="psiTable" aria-live="polite">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr><td colspan="99" id="meta" class="muted">—</td></tr>
          </tfoot>
        </table>
      </div>
      <div class="legend">
        This table lists every reading returned by the API (e.g., <code>o3_sub_index</code> to
        <code>psi_twenty_four_hourly</code>) across all regions (national, north, south, east, west, central).
      </div>
    </div>

    <p class="muted" style="margin-top:16px">
      Tip: If you see nothing, try again — occasionally the API may have a brief empty window while it rolls to a new timestamp.
    </p>
    <p id="error" class="error"></p>
  </main>

  <script>
    const API = "https://api.data.gov.sg/v1/environment/psi";
    const thead = document.getElementById("thead");
    const tbody = document.getElementById("tbody");
    const meta  = document.getElementById("meta");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");
    const refreshBtn = document.getElementById("refreshBtn");

    async function fetchPSI() {
      statusEl.textContent = "Loading…";
      errorEl.textContent = "";
      try {
        const res = await fetch(API, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        const items = Array.isArray(data.items) ? data.items : [];
        if (items.length === 0) {
          throw new Error("No items in response.");
        }

        const item = items[0];
        const readings = item.readings || {};
        const readingNames = Object.keys(readings).sort();

        // Determine region columns dynamically from the first reading
        const firstReading = readings[readingNames[0]] || {};
        const regionNames = Object.keys(firstReading).sort(); // e.g., ["central","east","national","north","south","west"]

        // Build header
        thead.innerHTML = "";
        const thRow = document.createElement("tr");
        const thReading = document.createElement("th");
        thReading.textContent = "Reading";
        thRow.appendChild(thReading);
        for (const region of regionNames) {
          const th = document.createElement("th");
          th.textContent = region;
          thRow.appendChild(th);
        }
        thead.appendChild(thRow);

        // Build body
        tbody.innerHTML = "";
        for (const readingKey of readingNames) {
          const row = document.createElement("tr");
          const nameCell = document.createElement("td");
          nameCell.textContent = readingKey;
          row.appendChild(nameCell);

          const regionObj = readings[readingKey] || {};
          for (const region of regionNames) {
            const td = document.createElement("td");
            const val = regionObj[region];
            td.textContent = (val ?? "") === "" ? "—" : Number.isFinite(val) ? Number(val).toFixed(2) : val;
            row.appendChild(td);
          }
          tbody.appendChild(row);
        }

        // Meta
        const ts = item.timestamp || data.update_timestamp || data.api_info?.status;
        meta.textContent = `Timestamp: ${ts || "unknown"} · Regions: ${regionNames.join(", ")} · Readings: ${readingNames.length}`;

        statusEl.textContent = "Loaded";
      } catch (err) {
        statusEl.textContent = "Error";
        errorEl.textContent = `Failed to load PSI data: ${err.message}`;
        thead.innerHTML = "";
        tbody.innerHTML = "";
        meta.textContent = "—";
      }
    }

    refreshBtn.addEventListener("click", fetchPSI);
    fetchPSI();
  </script>
</body>
</html>
